# =============================================================================
# æ¨¡æ¿å…ƒæ•°æ®å®šä¹‰æ–‡ä»¶ - æ¼æ´æŠ¥å‘Š (vuln_report)
# =============================================================================
# æ­¤æ–‡ä»¶å®šä¹‰äº†æ¨¡æ¿çš„æ‰€æœ‰å­—æ®µã€åˆ†ç»„ã€æ•°æ®æºå¼•ç”¨å’Œè¡Œä¸ºè§„åˆ™
# å‰ç«¯ä¼šæ ¹æ®æ­¤ schema åŠ¨æ€ç”Ÿæˆè¡¨å•ï¼Œåç«¯æ ¹æ®æ­¤ schema è¿›è¡Œæ•°æ®éªŒè¯å’Œå¤„ç†
# =============================================================================

# --- åŸºæœ¬ä¿¡æ¯ ---
id: vuln_report
name: é£é™©éšæ‚£æŠ¥å‘Š
description: ç”¨äºç”Ÿæˆç½‘ç»œå®‰å…¨é£é™©éšæ‚£æŠ¥å‘Šï¼Œé€‚ç”¨äºæ¼æ´é€šæŠ¥ã€å®‰å…¨æ£€æŸ¥ç­‰åœºæ™¯
version: "1.0.0"
order: 1
template_file: template.docx
icon: ""
author: ReportGenX Team
create_time: "2026-01-24"
update_time: "2026-01-24"

# --- å­—æ®µåˆ†ç»„å®šä¹‰ ---
# æ§åˆ¶å‰ç«¯è¡¨å•çš„åˆ†å—æ˜¾ç¤º
field_groups:
  - id: basic
    name: åŸºç¡€ä¿¡æ¯
    icon: "ğŸ“‹"
    order: 1
    collapsed: false  # é»˜è®¤æ˜¯å¦æŠ˜å 
    
  - id: target
    name: ç›®æ ‡èµ„äº§ä¿¡æ¯
    icon: "ğŸ¯"
    order: 2
    collapsed: false
    
  - id: vuln
    name: æ¼æ´è¯¦æƒ…
    icon: "ğŸ”"
    order: 3
    collapsed: false
    
  - id: evidence
    name: æ¼æ´å¤ç°è¯æ®
    icon: "ğŸ“·"
    order: 4
    collapsed: false

# --- å…±äº«æ•°æ®æºå®šä¹‰ ---
# å£°æ˜æ­¤æ¨¡æ¿éœ€è¦çš„æ•°æ®æºï¼Œåç«¯ä¼šæ ¹æ®è¿™äº›å®šä¹‰åŠ è½½æ•°æ®
data_sources:
  - id: vulnerabilities
    type: database
    description: æ¼æ´åº“æ•°æ®
    
  - id: icp_cache
    type: database
    description: ICP å¤‡æ¡ˆç¼“å­˜åº“
    
  - id: hazard_types
    type: config
    config_key: hazard_type
    description: éšæ‚£ç±»å‹é€‰é¡¹
    
  - id: unit_types
    type: config
    config_key: unitType
    description: å•ä½ç±»å‹é€‰é¡¹
    
  - id: industries
    type: config
    config_key: industry
    description: è¡Œä¸šç±»å‹é€‰é¡¹

# --- å­—æ®µå®šä¹‰ ---
# æ¯ä¸ªå­—æ®µå¯¹åº”æ¨¡æ¿ä¸­çš„ä¸€ä¸ªå ä½ç¬¦ (ä¸å« #)
fields:
  # ========== åŸºç¡€ä¿¡æ¯ç»„ ==========
  - key: vulnerability_id
    label: éšæ‚£ç¼–å·
    type: text
    group: basic
    order: 1
    required: false
    readonly: true
    auto_generate: true
    auto_generate_rule: "YHBH-{date:YYYYMMDD}-{seq:4}"
    placeholder: è‡ªåŠ¨ç”Ÿæˆ
    help_text: ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ä¸º YHBH-æ—¥æœŸ-åºå·
    template_placeholder: "#vulnerability_id#"
    
  - key: hazard_type
    label: éšæ‚£ç±»å‹
    type: select
    group: basic
    order: 2
    required: true
    source: hazard_types
    default: æ¼æ´æŠ¥å‘Š
    template_placeholder: "#hazard_type#"
    
  - key: discovery_date
    label: å‘ç°æ—¶é—´
    type: date
    group: basic
    order: 3
    required: true
    default: today
    format: "YYYY-MM-DD"
    template_placeholder: "#discoveryDate#"
    
  - key: hazard_level
    label: éšæ‚£çº§åˆ«
    type: select
    group: basic
    order: 4
    required: true
    source: config.risk_levels
    default: é«˜å±
    on_change: update_alert_level
    template_placeholder: "#hazardLevel#"
    
  - key: alert_level
    label: é¢„è­¦çº§åˆ«
    type: text
    group: basic
    order: 5
    required: false
    readonly: true
    computed: true
    compute_from: hazard_level
    compute_rule:
      è¶…å±: 1çº§
      é«˜å±: 2çº§
      ä¸­å±: 3çº§
      ä½å±: 4çº§
      ä¿¡æ¯æ€§: 5çº§
    template_placeholder: "#alertLevel#"
    
  - key: unit_type
    label: å•ä½ç±»å‹
    type: select
    group: basic
    order: 6
    required: true
    source: unit_types
    default: æ°‘è¥ä¼ä¸š
    template_placeholder: "#unitType#"
    
  - key: industry
    label: æ‰€å±è¡Œä¸š
    type: select
    group: basic
    order: 7
    required: true
    source: industries
    default: ç§‘æŠ€
    template_placeholder: "#industry#"
    
  - key: supplier_name
    label: æŠ€æœ¯æ”¯æŒå•ä½
    type: text
    group: basic
    order: 8
    required: false
    source: config.supplierName
    editable_config: true
    save_to_config: true
    template_placeholder: "#supplierName#"

  # ========== ç›®æ ‡èµ„äº§ä¿¡æ¯ç»„ ==========
  - key: url
    label: éšæ‚£ URL / IP
    type: text
    group: target
    order: 1
    required: true
    placeholder: "http://example.com/admin"
    help_text: è¾“å…¥åè‡ªåŠ¨è§£æåŸŸåå’ŒIPï¼Œæ”¯æŒç²˜è´´
    on_change: resolve_url
    validation:
      pattern: "^(https?://|\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}).*"
      message: è¯·è¾“å…¥æœ‰æ•ˆçš„ URL æˆ– IP åœ°å€
    template_placeholder: "#target#"
    
  - key: website_name
    label: ç½‘ç«™åç§°
    type: text
    group: target
    order: 2
    required: false
    auto_fill_from: icp_lookup
    template_placeholder: "#websiteName#"
    
  - key: domain
    label: ç½‘ç«™åŸŸå
    type: text
    group: target
    order: 3
    required: false
    auto_fill_from: url_parse
    template_placeholder: "#domain#"
    
  - key: ip
    label: ç½‘ç«™ IP
    type: text
    group: target
    order: 4
    required: false
    auto_fill_from: url_resolve
    template_placeholder: "#ip#"
    
  - key: unit_name
    label: å•ä½åç§°
    type: text
    group: target
    order: 5
    required: true
    auto_fill_from: icp_lookup
    template_placeholder: "#customerCompanyName#"
    
  - key: icp_number
    label: å¤‡æ¡ˆå·
    type: text
    group: target
    order: 6
    required: false
    auto_fill_from: icp_lookup
    template_placeholder: "#icpNumber#"
    
  - key: city
    label: åŸå¸‚
    type: text
    group: target
    order: 7
    required: false
    default: åŒ—äº¬
    source: config.city
    inline_group: region_group
    template_placeholder: "#city#"
    
  - key: region
    label: åœ°åŒº
    type: text
    group: target
    order: 8
    required: false
    default: æµ·æ·€åŒº
    source: config.region
    inline_group: region_group
    template_placeholder: "#region#"
    
  - key: icp_screenshot
    label: å·¥ä¿¡å¤‡æ¡ˆæˆªå›¾
    type: image
    group: target
    order: 9
    required: false
    accept: ".png,.jpg,.jpeg,.gif,.bmp"
    max_size_mb: 5
    help_text: ç‚¹å‡»ä¸Šä¼ æˆ–ç²˜è´´å¤‡æ¡ˆæˆªå›¾
    paste_enabled: true
    template_placeholder: "#icpScreenshot#"

  # ========== æ¼æ´è¯¦æƒ…ç»„ ==========
  - key: vul_name_select
    label: æ¼æ´åç§° (ä»åº“ä¸­é€‰)
    type: searchable_select
    group: vuln
    order: 1
    required: false
    source: vulnerabilities
    search_placeholder: è¾“å…¥å…³é”®è¯å¿«é€Ÿç­›é€‰...
    on_change: fill_vuln_details
    display_field: name
    value_field: id
    
  - key: vul_name
    label: è‡ªå®šä¹‰æ¼æ´åç§°
    type: text
    group: vuln
    order: 2
    required: true
    placeholder: å¦‚åº“ä¸­æ²¡æœ‰ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥
    help_text: å¦‚åº“ä¸­æ²¡æœ‰ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥
    template_placeholder: "#vulName#"
    
  - key: vul_description
    label: æ¼æ´æè¿°
    type: textarea
    group: vuln
    order: 3
    required: true
    rows: 4
    auto_fill_from: vuln_select
    fill_field: Vuln_Description
    template_placeholder: "#vulDescription#"
    
  - key: vul_harm
    label: æ¼æ´å±å®³
    type: textarea
    group: vuln
    order: 4
    required: false
    rows: 3
    auto_fill_from: vuln_select
    fill_field: Vuln_Impact
    template_placeholder: "#vulHarm#"
    
  - key: repair_suggestion
    label: ä¿®å¤å»ºè®®
    type: textarea
    group: vuln
    order: 5
    required: true
    rows: 3
    auto_fill_from: vuln_select
    fill_field: Repair_suggestions
    template_placeholder: "#repairSuggestion#"
    
  - key: remarks
    label: å¤‡æ³¨
    type: text
    group: vuln
    order: 6
    required: false
    template_placeholder: "#remarks#"

  # ========== æ¼æ´å¤ç°è¯æ®ç»„ ==========
  - key: vuln_evidence_images
    label: æ¼æ´æˆªå›¾
    type: image_list
    group: evidence
    order: 1
    required: false
    accept: ".png,.jpg,.jpeg,.gif,.bmp"
    max_size_mb: 5
    with_description: true
    description_placeholder: è¯·è¾“å…¥æˆªå›¾è¯´æ˜...
    paste_enabled: true
    help_text: ç‚¹å‡»ä¸Šä¼ æˆ–ç²˜è´´æ¼æ´è¯æ˜æˆªå›¾
    template_placeholder: "#vulnEvidenceImages#"

# --- è¡Œä¸ºå®šä¹‰ ---
# å®šä¹‰å­—æ®µé—´çš„è”åŠ¨å…³ç³»å’Œè‡ªåŠ¨åŒ–æ“ä½œ
behaviors:
  - id: resolve_url
    trigger:
      field: url
      event: change
    actions:
      - type: api_call
        endpoint: /api/process-url
        params:
          url: "${url}"
        result_mapping:
          domain: domain
          ip: ip
          "icp_info.unitName": unit_name
          "icp_info.mainLicence": icp_number
          "icp_info.serviceName": website_name
          
  - id: update_alert_level
    trigger:
      field: hazard_level
      event: change
    actions:
      - type: compute
        target: alert_level
        rules:
          è¶…å±: 1çº§
          é«˜å±: 2çº§
          ä¸­å±: 3çº§
          ä½å±: 4çº§
          ä¿¡æ¯æ€§: 5çº§
          
  - id: fill_vuln_details
    trigger:
      field: vul_name_select
      event: change
    actions:
      - type: api_call
        endpoint: /api/vulnerability/${vul_name_select}
        result_mapping:
          Vuln_Name: vul_name
          Vuln_Description: vul_description
          Vuln_Impact: vul_harm
          Repair_suggestions: repair_suggestion
          Hazard_level: hazard_level

# --- éªŒè¯è§„åˆ™ ---
# è¡¨å•æäº¤å‰çš„éªŒè¯
validation:
  rules:
    - fields: [vul_name, vul_description, repair_suggestion]
      rule: required
      message: æ¼æ´åç§°ã€æè¿°å’Œä¿®å¤å»ºè®®ä¸ºå¿…å¡«é¡¹
      
    - fields: [unit_name]
      rule: required
      message: å•ä½åç§°ä¸ºå¿…å¡«é¡¹
      
  custom_validators:
    - id: url_format
      field: url
      validator: url_or_ip
      message: è¯·è¾“å…¥æœ‰æ•ˆçš„ URL æˆ– IP åœ°å€

# --- è¾“å‡ºé…ç½® ---
output:
  filename_pattern: "{unit_name}_{vul_name}_{date}.docx"
  output_dir: "output/report/{unit_name}"
  log_to_db: true
  log_table: report

# --- é¢„è§ˆé…ç½® ---
preview:
  enabled: true
  fields:
    - key: unit_name
      label: å•ä½
    - key: vul_name
      label: æ¼æ´
    - key: hazard_level
      label: çº§åˆ«
    - key: url
      label: ç›®æ ‡
