# 📦 部署与运维指南

> 更新日期: 2026-02-09

## 1. 部署环境要求

### 硬件要求
- **CPU**: 2 核及以上
- **内存**: 4GB 及以上
- **硬盘**: 至少 500MB 可用空间（用于存储生成的报告和日志）

### 软件要求 (Web 模式)
- **操作系统**: Windows (推荐 Server 2016+), Linux (Ubuntu 20.04+, CentOS 7+)
- **Python**: 3.9 及以上 (仅源码部署需要)
- **端口**: 默认占用 `8000` (可配置)

---

## 2. 部署模式详解

### A. 移动/桌面单机模式 (Electron)
适用于安全服务人员各自分发使用，无需中心服务器。
*   **分发方式**: 直接分发打包好的文件夹或安装包。
*   **运行**:双击 `ReportGenX.exe` (主程序)。
*   **数据**: 数据保存在本地 `data/` 目录。

### B. 团队协作模式 (Web Service)
适用于团队内网共享，集中管理模板和可访问性。

**步骤：**
1.  将 `app/` 目录上传至服务器（确保包含 `api.exe` 或源码）。
2.  修改 `shared-config.json`，将 host 改为 `0.0.0.0` 以允许外部访问。
    ```json
    {
      "server": {
        "host": "0.0.0.0",
        "port": 8000
      }
    }
    ```
3.  **启动服务**:
    *   **Windows**: 在终端运行 `./api.exe`
    *   **Linux (源码运行)**:
        ```bash
        # 安装依赖
        pip install -r requirements.txt
        # 启动后台服务
        nohup python backend/api.py > output.log 2>&1 &
        ```
4.  **访问**: 打开浏览器访问 `http://<服务器IP>:8000`。

---

## 3. 配置详解

### 全局服务配置 (`shared-config.json`)
控制服务器监听地址与端口。仅影响 API 服务启动参数，不影响业务逻辑。

| 参数 | 说明 | 默认值 |
| :--- | :--- | :--- |
| `host` | 监听 IP。`127.0.0.1` 仅本机访问，`0.0.0.0` 允许公网/局域网访问 | `127.0.0.1` |
| `port` | 监听端口 | `8000` |

### 业务配置 (`config.yaml`)
控制报告生成行为、下拉选项、默认值等。

*   **数据库路径**: `vul_or_icp: data/combined.db`
*   **版本号**: `version: V0.17.7`
*   **风险等级定义**: `risk_levels` (修改此处可调整报告中的风险颜色和文案)
*   **预设选项**: 可自定义 `operating_systems`, `hazard_types`, `industries` 等下拉列表内容。

---

## 4. 安全说明 (Security Notice)

为了保障系统安全，部署时请注意以下事项：

### 1. 模板安全
*   **白名单机制**: 系统内置了依赖包白名单，仅允许加载安全的 Python 库。
*   **来源审计**: 请勿随意加载来源不明的模板文件夹，虽然系统有沙箱机制，但恶意代码仍可能造成风险。
*   **路由隔离**: 所有插件接口均被强制隔离在 `/api/plugin/` 下，防止覆盖系统核心 API。

### 2. 文件上传
*   **格式限制**: 图片上传接口已加固，仅支持 `png, jpg, jpeg, gif` 等安全格式。
*   **大小限制**: 单个文件上传限制为 10MB。

### 3. 数据安全
*   **SQL 注入防御**: 核心数据库操作已启用严格的参数化查询和标识符校验。
*   **备份建议**: 建议定期使用工具箱的“数据备份”功能导出 `.db` 文件。

## 5. 目录与文件维护

打包后的应用结构如下：

```
app/
├── api.exe                    # 后端服务主程序
├── shared-config.json         # [关键] 网络监听配置
├── config.yaml                # [关键] 业务配置
├── data/                      # 数据持久化目录
│   └── combined.db            # 核心知识库 (SQLite)
├── templates/                 # 模板插件目录
│   ├── vuln_report/
│   │   ├── schema.yaml
│   │   ├── template.docx
│   │   └── handler.py
│   └── ...
├── src/                       # 前端静态资源 (Web模式专用)
├── output/                    # 运行时产物
│   ├── report/                # 生成的报告归档
│   ├── temp/                  # 临时上传文件
│   └── logs/                  # 系统运行日志
└── ...
```

## 6. 运维操作

### 添加新模板
无需重新编译，支持热插拔。

1.  将新模板文件夹复制到 `templates/` 目录。
    *   必须包含: `schema.yaml`, `handler.py`
    *   可选: `template.docx`
2.  **热加载**:
    *   方法 A: 重启服务/应用。
    *   方法 B: 调用 API `POST /api/templates/reload` (无需重启)。

### 备份与恢复
建议定期备份以下目录：
*   `data/`: 包含自定义的漏洞库数据。
*   `config.yaml`: 包含自定义的业务配置。
*   `templates/`: 包含所有自定义的报告模板。

### 日志排查
所有运行日志位于 `output/logs/` 目录下。
*   `api.log`: 记录接口调用和常规报错。
*   `report_generation.log`: 专门记录报告生成过程中的详细调试信息。

### 常见问题 (FAQ)

**Q: 模板加载失败，提示 `InvalidTemplateIdError`？**
A: 检查 `templates/` 下的文件夹名称。只能包含字母、数字、下划线，且不能以数字开头。

**Q: Web 模式下无法上传图片？**
A: 检查 `output/temp/` 目录是否有写入权限。Linux 环境需执行 `chmod -R 755 output/`。

**Q: 修改了 config.yaml 没生效？**
A: 业务配置目前是在服务启动时加载的。修改 `config.yaml` 后必须**重启服务**。

**Q: 热加载能更新路由吗？**
A: 不能。如果模板的 `handler.py` 中定义了新的 API 路由（例如 `@router.get(...)`），必须重启服务才能生效。如果不涉及新路由仅修改逻辑，可以使用热加载。
